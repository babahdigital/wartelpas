!function(){var e=document.getElementById("selling-config");if(e){var t={sessionId:e.dataset.sessionId||"",sessionQs:e.dataset.sessionQs||"",filterDate:e.dataset.filterDate||"",reqShow:e.dataset.reqShow||"harian",price10:parseInt(e.dataset.price10||"0",10),price30:parseInt(e.dataset.price30||"0",10),reportUrl:e.dataset.reportUrl||"./?report=selling",ghostUrl:e.dataset.ghostUrl||"report/laporan/ghost.php",auditUserUrl:e.dataset.auditUserUrl||"report/laporan/services/audit_users.php",auditLocked:"1"===e.dataset.auditLocked,auditUsers:n(e.dataset.auditUsers),auditProfiles:n(e.dataset.auditProfiles),profileLabels:n(e.dataset.profileLabels)};window.sellingConfig=t}function n(e){try{return JSON.parse(e||"[]")}catch(e){return[]}}}();var settlementTimer=null,hpDeleteUrl="",settlementLastFetch=0,auditUserOptions=window.sellingConfig&&window.sellingConfig.auditUsers?window.sellingConfig.auditUsers:[],auditSelectedUsers=[],auditSelectedSet=new Set,auditUserCache=[],auditUserProfileKeys=[],auditUserActiveKey="",auditUserEligibleCount=0,auditReturTotal=0;function updateCharRemainingForInput(e){if(e&&e.getAttribute){var t=e.getAttribute("id");if(t){var n=document.querySelectorAll('.char-remaining[data-target="'+t+'"]');if(n&&n.length){var a=(e.value||"").toString();n.forEach((function(t){var n=parseInt(t.dataset.max||e.maxLength||"0",10);(!n||n<0)&&(n=0);var i=n-a.length;i<0&&(i=0),t.textContent=i}))}}}}function initCharRemaining(){var e=document.querySelectorAll(".char-remaining[data-target]");e&&e.length&&e.forEach((function(e){var t=e.dataset.target||"";if(t){var n=document.getElementById(t);n&&(n.dataset.charRemainingBound||(n.addEventListener("input",(function(){updateCharRemainingForInput(n)})),n.dataset.charRemainingBound="1"),updateCharRemainingForInput(n))}}))}function formatDateDMY(e){if(!e)return"-";var t=String(e).match(/^(\d{4})-(\d{2})-(\d{2})/);return t?t[3]+"-"+t[2]+"-"+t[1]:e}function buildReportUrl(e){var t=window.sellingConfig||{},n=new URL(t.reportUrl||"./?report=selling",window.location.href);return t.sessionId&&n.searchParams.set("session",t.sessionId),e&&"object"==typeof e&&Object.keys(e).forEach((function(t){var a=e[t];null!=a&&""!==a&&n.searchParams.set(t,a)})),n.toString()}function openNoteModal(){var e=document.getElementById("noteModal");if(e&&(e.style.display="flex"),e){var t=e.querySelector('textarea[name="note_text"]');t&&(t.disabled=!1,t.readOnly=!1,t.focus())}}function closeNoteModal(){var e=document.getElementById("noteModal");e&&(e.style.display="none")}function closeDeleteHpModal(){var e=document.getElementById("hp-delete-modal");e&&(e.style.display="none")}function confirmDeleteHpModal(){if(!hpDeleteUrl)return closeDeleteHpModal();window.location.href=hpDeleteUrl}function openDeleteHpModal(e,t,n){hpDeleteUrl=e||"";var a=document.getElementById("hp-delete-modal"),i=document.getElementById("hp-delete-text"),o=formatDateDMY(n||"");i&&(i.textContent="Hapus data Blok "+(t||"-")+" tanggal "+(o||"-")+"?"),a&&(a.style.display="flex")}function manualSettlement(){var e=window.sellingConfig||{},t=document.getElementById("btn-settlement");if(t&&!t.disabled){var n=document.getElementById("settlement-modal"),a=document.getElementById("settlement-log"),i=document.getElementById("settlement-log-wrap"),o=document.getElementById("settlement-footer"),l=document.getElementById("settlement-status"),r=document.getElementById("processStatus"),s=document.getElementById("settlement-close"),d=document.getElementById("settlement-confirm"),u=document.getElementById("settlement-start"),c=document.getElementById("settlement-cancel");window.settleDone=!1,window.settleTimer&&(clearInterval(window.settleTimer),window.settleTimer=null),window.settleQueue=[],window.settleSeen={},window.settleInfoShown=!1,window.settleStatus="",window.settleFastMode=!1,updateSettlementCloseState(),n&&(n.style.display="flex"),a&&(a.innerHTML=""),i&&(i.style.display="none"),o&&(o.style.display="none"),l&&(l.textContent="Menunggu konfirmasi"),r&&(r.innerHTML='<i class="fa fa-refresh"></i> Menunggu proses...'),s&&(s.disabled=!0,s.style.opacity="0.6",s.style.cursor="not-allowed"),d&&(d.style.display="flex"),c&&(c.disabled=!1,c.style.opacity="1",c.style.cursor="pointer",c.onclick=function(){n&&(n.style.display="none")}),u&&(u.onclick=function(){d&&(d.style.display="none"),i&&(i.style.display="block"),o&&(o.style.display="flex"),l&&(l.textContent="Menjalankan settlement..."),r&&(r.innerHTML='<i class="fa fa-refresh fa-spin"></i> Menghubungkan ke MikroTik...'),t.disabled=!0,t.style.opacity="0.6",t.style.cursor="not-allowed",s&&(s.disabled=!0,s.style.opacity="0.6",s.style.cursor="not-allowed"),c&&(c.disabled=!0,c.style.opacity="0.6",c.style.cursor="not-allowed"),a&&(a.innerHTML='<span class="cursor-blink"></span>'),enqueueSettlementLogs([{time:"",topic:"system,info",type:"info",message:"Sabar, sedang mengambil log settlement..."}]);var n=new URLSearchParams;e.sessionId&&n.set("session",e.sessionId),n.set("date",e.filterDate||""),n.set("action","start"),pollSettlementLogs(),fetch("report/laporan/services/settlement_manual.php?"+n.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.json()})).then((function(e){if(!e||!e.ok)return l&&(l.textContent=e&&e.message?e.message:"Settlement gagal."),t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer",void(c&&(c.disabled=!1,c.style.opacity="0.8",c.style.cursor="pointer"))})).catch((function(){l&&(l.textContent="Settlement gagal."),t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer",c&&(c.disabled=!1,c.style.opacity="0.8",c.style.cursor="pointer")}))})}}function pollSettlementLogs(){var e=window.sellingConfig||{},t=document.getElementById("settlement-log"),n=(document.getElementById("settlement-status"),document.getElementById("processStatus"),document.getElementById("settlement-close"),new URLSearchParams);e.sessionId&&n.set("session",e.sessionId),n.set("date",e.filterDate||""),n.set("action","logs"),n.set("_",Date.now().toString()),fetch("report/laporan/services/settlement_manual.php?"+n.toString(),{headers:{"X-Requested-With":"XMLHttpRequest","Cache-Control":"no-store"},cache:"no-store"}).then((function(e){return e.json()})).then((function(e){return e&&Array.isArray(e.logs)&&t&&enqueueSettlementLogs(e.logs),e&&e.info_message&&(window.settleInfoShown||(window.settleInfoShown=!0,enqueueSettlementLogs([{time:"",topic:"system,info",type:"info",message:e.info_message}]))),e&&e.status&&(window.settleStatus=e.status,updateSettlementStatus()),e&&"done"===e.status?(window.settleDone=!0,updateSettlementCloseState(),updateSettlementStatus(),softReloadSelling(),void clearTimeout(settlementTimer)):e&&"failed"===e.status?(window.settleDone=!0,updateSettlementCloseState(),updateSettlementStatus(),void clearTimeout(settlementTimer)):void(settlementTimer=setTimeout(pollSettlementLogs,600))})).catch((function(){settlementTimer=setTimeout(pollSettlementLogs,800)}))}function openSettlementResetModal(){var e=document.getElementById("settlement-reset-modal");e&&(e.style.display="flex")}function closeSettlementResetModal(){var e=document.getElementById("settlement-reset-modal");e&&(e.style.display="none")}function confirmSettlementReset(){var e=window.sellingConfig||{},t=new URLSearchParams;e.sessionId&&t.set("session",e.sessionId),t.set("date",e.filterDate||""),t.set("action","reset"),fetch("report/laporan/services/settlement_manual.php?"+t.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.json()})).then((function(){window.location.reload()})).catch((function(){window.location.reload()}))}function closeSettlementModal(){var e=document.getElementById("settlement-close");if(!e||!e.disabled){var t=document.getElementById("settlement-modal");t&&(t.style.display="none")}}function updateSettlementCloseState(){var e=document.getElementById("settlement-close");e&&(!(!window.settleDone||window.settleTyping||window.settleQueue&&0!==window.settleQueue.length)?(e.disabled=!1,e.removeAttribute("disabled"),e.style.opacity="1",e.style.cursor="pointer"):(e.disabled=!0,e.style.opacity="0.6",e.style.cursor="not-allowed"))}function updateSettlementStatus(){var e=document.getElementById("settlement-status"),t=document.getElementById("processStatus");if(window.settleStatus){if(!!(!window.settleDone||window.settleTyping||window.settleQueue&&0!==window.settleQueue.length))return e&&(e.textContent="Berjalan"),void(t&&(t.innerHTML='<i class="fa fa-refresh fa-spin"></i> Sedang memproses...'));"done"===window.settleStatus?(e&&(e.textContent="Selesai"),t&&(t.innerHTML='<i class="fa fa-check-circle"></i> Selesai'),window.settleFinalInfoShown||(enqueueSettlementLogs([{time:"",topic:"system,info",type:"system",message:"Semua proses selesai. Silakan tutup terminal."}]),window.settleFinalInfoShown=!0)):"failed"===window.settleStatus&&(e&&(e.textContent="Gagal"),t&&(t.innerHTML='<i class="fa fa-times-circle"></i> Gagal'))}}function enqueueSettlementLogs(e){window.settleQueue||(window.settleQueue=[]),window.settleSeen||(window.settleSeen={}),e.forEach((function(e){if(e){var t=[e.time||"",e.topic||"",e.message||""].join("|");window.settleSeen[t]||(window.settleSeen[t]=!0,window.settleQueue.push(e))}})),window.settleQueue.length>100&&(window.settleFastMode=!0),window.settleTimer||(window.settleTimer=setInterval(renderSettlementLogItem,100))}function renderSettlementLogItem(){if(!window.settleTyping||window.settleFastMode)if(window.settleQueue&&0!==window.settleQueue.length){var e=document.getElementById("settlement-log");if(e){var t=window.settleQueue.shift(),n=t.time||"",a=t.topic||"system,info",i=t.message||"",o=t.type||"info",l=document.createElement("div");l.className="log-entry";var r=document.createElement("span");r.className="log-prompt",r.textContent="> ";var s=document.createElement("span");s.className="log-time",s.textContent=n?String(n)+" ":"";var d=document.createElement("span");d.className="log-topic",d.textContent=a?String(a)+" ":"";var u=document.createElement("span");u.className="log-"+String(o).replace(/[^a-z]/gi,""),u.textContent="",l.appendChild(r),l.appendChild(s),l.appendChild(d),l.appendChild(u);var c=e.querySelector(".cursor-blink");if(c&&c.remove(),e.appendChild(l),e.scrollTop=e.scrollHeight,window.settleFastMode){u.textContent=String(i);var m=document.createElement("span");return m.className="cursor-blink",e.appendChild(m),e.scrollTop=e.scrollHeight,updateSettlementCloseState(),void updateSettlementStatus()}window.settleTyping=!0;setTimeout((function(){typeSettlementMessage(u,String(i),15,(function(){window.settleTyping=!1;var t=document.createElement("span");t.className="cursor-blink",e.appendChild(t),e.scrollTop=e.scrollHeight,updateSettlementCloseState(),updateSettlementStatus()}))}),150)}}else window.settleDone&&(updateSettlementStatus(),clearInterval(window.settleTimer),window.settleTimer=null,updateSettlementCloseState())}function typeSettlementMessage(e,t,n,a){var i=0,o=t.length;!function l(){i>=o?a&&a():(e.textContent+=t.charAt(i),i+=1,setTimeout(l,n))}()}function openHpModal(){var e=document.getElementById("hpModal");e&&(e.style.display="flex"),window.sellingPauseReload=!0,window.hpEditing||(applyHpDefaults(!0),scheduleHpAutoSave(!0))}function closeHpModal(){var e=document.getElementById("hpModal");e&&(e.style.display="none"),window.sellingPauseReload=!1,window.hpEditing=!1}function applyHpDefaults(e){var t=document.getElementById("hpForm");if(t){var n=t.querySelector('select[name="blok_name"]'),a=t.querySelector('input[name="report_date"]'),i=n?n.value:"",o=a?a.value:"";if(i&&o){var l=window.hpTodayMapByDate||{},r=l[o]||{},s=(window.hpDefaultCache||{})[o]||{},d=r[i]||s[i];d?fillHpForm(t,d,e):fetchHpDefaults(o,(function(){var n=(window.hpDefaultCache||{})[o]||{},a=(l[o]||{})[i]||n[i];a&&fillHpForm(t,a,e)}))}}}function fillHpForm(e,t,n){var a=e.querySelector('input[name="wartel_units"]'),i=e.querySelector('input[name="kamtib_units"]'),o=e.querySelector('input[name="rusak_units"]'),l=e.querySelector('input[name="spam_units"]'),r=e.querySelector('input[name="notes"]'),s=function(e){if(!e)return!0;var t=(e.value||"").toString().trim();return""===t||"0"===t};if(n||s(a)&&s(i)&&s(o)&&s(l)&&(!r||""===r.value.trim())){if(a&&(a.value=t.wartel_units||0),i&&(i.value=t.kamtib_units||0),o&&(o.value=t.rusak_units||0),l&&(l.value=t.spam_units||0),r&&(r.value=t.notes||""),r&&updateCharRemainingForInput(r),"function"==typeof window.dispatchEvent){var d=new Event("input",{bubbles:!0});a&&a.dispatchEvent(d),i&&i.dispatchEvent(d),o&&o.dispatchEvent(d),l&&l.dispatchEvent(d)}scheduleHpAutoSave(!0)}}window.auditEditing=!1,function(){var e=document.getElementById("settlement-close");e&&e.addEventListener("click",(function(){if(!e.disabled){var t=document.getElementById("settlement-modal");t&&(t.style.display="none")}}))}(),function(){var e=document.getElementById("hp-delete-modal"),t=document.getElementById("hp-delete-close"),n=document.getElementById("hp-delete-cancel"),a=document.getElementById("hp-delete-confirm"),i=function(){e&&(e.style.display="none")};t&&t.addEventListener("click",i),n&&n.addEventListener("click",i),a&&a.addEventListener("click",(function(){if(!hpDeleteUrl)return i();window.location.href=hpDeleteUrl}))}(),function(){var e=document.getElementById("hpForm");if(e){var t=document.getElementById("hpSubmitBtn"),n=document.getElementById("hpClientError"),a=e.querySelector('input[name="total_units"]'),i=e.querySelector('input[name="active_units"]'),o=e.querySelector('input[name="wartel_units"]'),l=e.querySelector('input[name="kamtib_units"]'),r=e.querySelector('input[name="rusak_units"]'),s=e.querySelector('input[name="spam_units"]');[o,l,r,s].forEach((function(e){e&&e.addEventListener("input",(function(){!function(e){if(e){var t=d(e);t<0&&(t=0),e.value=t}}(e),u()}))})),e.addEventListener("submit",(function(a){if(a.preventDefault(),!t||!t.disabled){window.sellingPauseReload=!0;var i=new FormData(e);i.append("ajax","1"),fetch(e.action,{method:"POST",body:i,headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.text()})).then((function(a){var i=null;try{i=JSON.parse(a)}catch(e){}if(i&&i.ok&&i.redirect){var o=getHpFormSnapshot(e);return o&&o.blok&&(window.hpTodayMapByDate=window.hpTodayMapByDate||{},window.hpTodayMapByDate[o.date]||(window.hpTodayMapByDate[o.date]={}),window.hpTodayMapByDate[o.date][o.blok]={wartel_units:parseInt(o.wartel||"0",10)||0,kamtib_units:parseInt(o.kamtib||"0",10)||0,total_units:parseInt(o.total||"0",10)||0,rusak_units:parseInt(o.rusak||"0",10)||0,spam_units:parseInt(o.spam||"0",10)||0,notes:o.notes||""}),void window.location.replace(i.redirect)}var l=i&&i.message?i.message:"Respon tidak valid dari server.";n.textContent=l,n.style.display="block",t&&(t.disabled=!0)})).catch((function(){n.textContent="Gagal mengirim data. Coba lagi.",n.style.display="block",t&&(t.disabled=!0)}))}})),u()}function d(e){var t=e?parseInt(e.value||"0",10):0;return isNaN(t)?0:t}function u(){if(t&&n){var e=d(o),u=d(l),c=d(r),m=d(s),p=e+u;a&&(a.value=p);var f=p-c-m;i&&(i.value=f>=0?f:0);var y="";p<=0?y="Total unit masih 0. Isi jumlah WARTEL atau KAMTIB.":p<c+m&&(y="Total unit tidak boleh kurang dari Rusak + Spam."),y?(n.textContent=y,n.style.display="block",t.disabled=!0):(n.textContent="",n.style.display="none",t.disabled=!1)}}}();var hpDefaultsFetchLock={};function fetchHpDefaults(e,t){if(window.hpDefaultsUrl&&e&&!hpDefaultsFetchLock[e]){hpDefaultsFetchLock[e]=!0;var n=window.hpDefaultsUrl+"?date="+encodeURIComponent(e);window.hpSessionId&&(n+="&session="+encodeURIComponent(window.hpSessionId)),fetch(n,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.json()})).then((function(n){n&&n.ok&&(window.hpDefaultCache=window.hpDefaultCache||{},window.hpDefaultCache[e]=n.data||{},window.hpDefaultSourceDate=n.source_date||""),"function"==typeof t&&t()})).catch((function(){"function"==typeof t&&t()})).finally((function(){hpDefaultsFetchLock[e]=!1}))}}var hpAutoTimer=null,hpAutoLastKey="";function getHpFormSnapshot(e){if(!e)return null;var t=(e.querySelector('select[name="blok_name"]')||{}).value||"",n=(e.querySelector('input[name="report_date"]')||{}).value||"",a=(e.querySelector('input[name="wartel_units"]')||{}).value||"0",i=(e.querySelector('input[name="kamtib_units"]')||{}).value||"0",o=(e.querySelector('input[name="rusak_units"]')||{}).value||"0",l=(e.querySelector('input[name="spam_units"]')||{}).value||"0",r=(e.querySelector('input[name="notes"]')||{}).value||"",s=(e.querySelector('input[name="total_units"]')||{}).value||"0";return n?{blok:t,date:n,wartel:a,kamtib:i,rusak:o,spam:l,notes:r,total:s}:null}function scheduleHpAutoSave(e){var t=document.getElementById("hpForm");if(t){var n=getHpFormSnapshot(t);if(n&&n.blok&&n.date){var a=JSON.stringify(n);(e||a!==hpAutoLastKey)&&(hpAutoLastKey=a,hpAutoTimer&&clearTimeout(hpAutoTimer),hpAutoTimer=setTimeout((function(){submitHpAutoSave(t,n)}),800))}}}function submitHpAutoSave(e,t){var n=document.getElementById("hpSubmitBtn"),a=document.getElementById("hpClientError");if(e&&(!n||!n.disabled)){var i=new FormData(e);i.append("ajax","1"),i.append("auto","1"),fetch(e.action,{method:"POST",body:i,headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.text()})).then((function(e){var n=null;try{n=JSON.parse(e)}catch(e){}if(n&&n.ok)return window.hpTodayMapByDate=window.hpTodayMapByDate||{},window.hpTodayMapByDate[t.date]||(window.hpTodayMapByDate[t.date]={}),window.hpTodayMapByDate[t.date][t.blok]={wartel_units:parseInt(t.wartel||"0",10)||0,kamtib_units:parseInt(t.kamtib||"0",10)||0,total_units:parseInt(t.total||"0",10)||0,rusak_units:parseInt(t.rusak||"0",10)||0,spam_units:parseInt(t.spam||"0",10)||0,notes:t.notes||""},void(a&&(a.textContent="Auto-save tersimpan.",a.style.display="block",a.style.color="#86efac"));var i=n&&n.message?n.message:"Auto-save gagal.";a&&(a.textContent=i,a.style.display="block",a.style.color="#fca5a5")})).catch((function(){a&&(a.textContent="Auto-save gagal. Coba lagi.",a.style.display="block",a.style.color="#fca5a5")}))}}function openAuditModal(){var e=document.getElementById("auditModal");if(e&&(e.style.display="flex"),window.sellingPauseReload=!0,window.auditEditing||"function"!=typeof resetAuditUserPicker||resetAuditUserPicker(),!window.auditEditing){var t=document.getElementById("auditForm"),n=t?t.querySelector('input[name="audit_setoran"]'):null,a=t?t.querySelector('input[name="audit_setoran_manual"]'):null;n&&(n.dataset.manual="0"),a&&(a.value="0")}}function closeAuditModal(){var e=document.getElementById("auditModal");e&&(e.style.display="none"),window.sellingPauseReload=!1,window.auditEditing=!1;var t=document.getElementById("auditForm");if(t){var n=t.querySelector('select[name="audit_blok"]');n&&(n.disabled=!1);var a=t.querySelector('input[name="audit_blok"][data-locked="1"]');a&&a.remove()}}function closeDeleteAuditModal(){var e=document.getElementById("audit-delete-modal");e&&(e.style.display="none")}function confirmDeleteAuditModal(){if(!window.auditDeleteUrl)return closeDeleteAuditModal();window.location.href=window.auditDeleteUrl}function openDeleteAuditModal(e,t,n){window.auditDeleteUrl=e||"";var a=document.getElementById("audit-delete-modal"),i=document.getElementById("audit-delete-text"),o=formatDateDMY(n||"");i&&(i.textContent="Hapus audit Blok "+(t||"-")+" tanggal "+(o||"-")+"?"),a&&(a.style.display="flex")}function closeAuditLockModal(){var e=document.getElementById("audit-lock-modal");e&&(e.style.display="none")}function confirmAuditLockModal(){if(!window.auditLockUrl)return closeAuditLockModal();window.location.href=window.auditLockUrl}function openAuditLockModal(){var e=window.sellingConfig||{};window.auditLockUrl=buildReportUrl({show:e.reqShow||"harian",date:e.filterDate||"",audit_lock:1,audit_date:e.filterDate||""});var t=document.getElementById("audit-lock-modal"),n=document.getElementById("audit-lock-text"),a=formatDateDMY(e.filterDate||"");n&&(n.textContent="Kunci audit tanggal "+(a||"-")+"? Setelah dikunci, data tidak bisa diedit."),t&&(t.style.display="flex")}function setAuditQtyLockState(e){var t=document.getElementById("auditForm");if(t){t.querySelectorAll(".audit-profile-qty").forEach((function(t){t.readOnly=!!e}));var n=t.querySelector('input[name="audit_setoran"]'),a=t.querySelector('input[name="audit_setoran_manual"]');n&&(n.readOnly=!!e,e&&(n.dataset.manual="0",a&&(a.value="0")));var i=document.getElementById("auditQtyLockHint");i&&(i.classList.toggle("locked",!!e),i.textContent=e?"Qty terkunci karena user dipilih.":"Qty otomatis dari user terpilih.")}}function updateAuditUserSummary(){var e=document.getElementById("auditUserTrigger"),t=document.getElementById("auditUserLabel"),n=document.getElementById("auditUserSummary"),a=document.getElementById("auditUserUnreported"),i=auditSelectedUsers.length;if(e&&e.classList.toggle("has-value",i>0),t&&(t.innerHTML=i>0?'<i class="fa fa-check"></i> '+i+" user terpilih":'<i class="fa fa-list-ul"></i> Pilih user terpakai & retur...'),n&&(n.textContent=i>0?"Terpilih: "+i+" user":"Belum ada user dipilih"),a)if(auditUserEligibleCount>0){var o=Math.max(auditUserEligibleCount-i,0);a.textContent="Tidak dilaporkan: "+o}else a.textContent="Tidak dilaporkan: -";var l=document.getElementById("auditUserUnreportedPopup");if(l)if(auditUserEligibleCount>0){var r=Math.max(auditUserEligibleCount-i,0);l.textContent="Tidak dilaporkan: "+r}else l.textContent="Tidak dilaporkan: -";var s=document.getElementById("auditUsernameHidden");s&&(s.value=auditSelectedUsers.join(", "))}function setAuditUserPicker(e){auditSelectedSet=new Set,String(e||"").split(",").map((function(e){return e.trim()})).filter(Boolean).forEach((function(e){auditSelectedSet.add(e)})),setAuditQtyLockState((auditSelectedUsers=Array.from(auditSelectedSet)).length>0),updateAuditUserSummary()}function resetAuditUserPicker(){auditSelectedSet=new Set,auditSelectedUsers=[],updateAuditUserSummary(),setAuditQtyLockState(!1)}function openAuditUserModal(){var e=document.getElementById("auditUserOverlay");e&&(e.style.display="flex",initAuditUserSearch(),loadAuditUserList())}function closeAuditUserModal(){var e=document.getElementById("auditUserOverlay");e&&(e.style.display="none")}function initAuditUserSearch(){var e=document.getElementById("auditUserSearch");if(e&&"1"!==e.dataset.bound){e.dataset.bound="1",e.addEventListener("input",(function(){renderAuditUserList()}));var t=document.getElementById("auditUserSearchClear");t&&t.addEventListener("click",(function(){e.value="",renderAuditUserList(),e.focus()}))}}function getAuditSearchTerms(){var e=document.getElementById("auditUserSearch");return e?String(e.value||"").split(",").map((function(e){return e.trim().toLowerCase()})).filter(Boolean):[]}function loadAuditUserList(){var e=window.sellingConfig||{},t=document.getElementById("auditForm"),n=t?(t.querySelector('select[name="audit_blok"]')||{}).value:"",a=t?(t.querySelector('input[name="audit_date"]')||{}).value:"",i=document.getElementById("auditUserList");i&&(i.innerHTML='<div style="text-align:center; padding:20px; color:#666;">Memuat data...</div>');var o=document.getElementById("auditUsernameHidden");if(o&&o.value&&setAuditUserPicker(o.value),n&&a){var l=new URL(e.auditUserUrl||"report/laporan/services/audit_users.php",window.location.href);l.searchParams.set("date",a),l.searchParams.set("blok",n),e.sessionId&&l.searchParams.set("session",e.sessionId),fetch(l.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.json()})).then((function(e){if(!e||!e.ok)throw new Error(e&&e.message||"Gagal memuat data user");auditUserCache=Array.isArray(e.users)?e.users:[],auditUserEligibleCount=auditUserCache.length,auditReturTotal=parseInt(e.retur_total||0,10)||0;var t=document.getElementById("auditReturTotal");t&&(t.value=String(auditReturTotal||0));var n={};auditUserCache.forEach((function(e){var t=String(e.profile_key||"").toLowerCase();t&&(n[t]=!0)})),(auditUserProfileKeys=Object.keys(n)).sort(),auditUserActiveKey=auditUserProfileKeys[0]||"",renderAuditUserTabs(),renderAuditUserList(),updateAuditUserSummary()})).catch((function(){i&&(i.innerHTML='<div style="text-align:center; padding:20px; color:#666;">Gagal memuat data.</div>')}))}else i&&(i.innerHTML='<div style="text-align:center; padding:20px; color:#666;">Pilih blok & tanggal terlebih dahulu.</div>')}function renderAuditUserTabs(){var e=document.getElementById("auditUserTabs");if(e)if(auditUserProfileKeys.length<=1)e.style.display="none";else{e.style.display="flex",e.innerHTML="";var t=(window.sellingConfig||{}).profileLabels||{};auditUserProfileKeys.forEach((function(n){var a=auditUserCache.filter((function(e){return String(e.profile_key||"").toLowerCase()===n})).length,i=document.createElement("div");i.className="audit-user-tab"+(n===auditUserActiveKey?" active":"");var o=t[n]||n.toUpperCase();i.innerHTML=o+' <span class="badge">'+a+"</span>",i.onclick=function(){auditUserActiveKey=n,renderAuditUserTabs(),renderAuditUserList()},e.appendChild(i)}))}}function renderAuditUserList(){var e=document.getElementById("auditUserList");if(e){var t=getAuditSearchTerms(),n=auditUserCache.filter((function(e){return!auditUserActiveKey||auditUserProfileKeys.length<=1||String(e.profile_key||"").toLowerCase()===auditUserActiveKey}));if(t.length&&(n=n.filter((function(e){var n=String(e.username||"").toLowerCase();return!!n&&t.some((function(e){return-1!==n.indexOf(e)}))}))),n.length){e.innerHTML="",n.forEach((function(t){var n=String(t.username||""),a=auditSelectedSet.has(n),i="RETUR"===String(t.status||"").toUpperCase(),o=document.createElement("div");o.className="audit-user-row"+(a?" selected":"")+(i?" is-retur":""),o.onclick=function(){toggleAuditUserSelect(n)};var l=document.createElement("div"),r=document.createElement("div");r.className="audit-user-name";var s="audit-user-badge "+(i?"retur":"terpakai");r.innerHTML=n+' <span class="'+s+'">'+(i?"RETUR":"TERPAKAI")+"</span>";var d=document.createElement("div");d.className="audit-user-meta",d.textContent="Uptime: "+(t.uptime||"-")+" | Byte: "+(t.bytes||"0 B"),l.appendChild(r),l.appendChild(d);var u=document.createElement("div");u.className="audit-user-check",u.innerHTML='<i class="fa fa-check"></i>',o.appendChild(l),o.appendChild(u),e.appendChild(o)}));var a=document.getElementById("auditUserSelectedCount");a&&(a.textContent=String(auditSelectedSet.size))}else e.innerHTML='<div style="text-align:center; padding:20px; color:#555;">Tidak ada data</div>'}}function toggleAuditUserSelect(e){auditSelectedSet.has(e)?auditSelectedSet.delete(e):auditSelectedSet.add(e),auditSelectedUsers=Array.from(auditSelectedSet),renderAuditUserList()}function applyAuditUserSelection(){var e=document.getElementById("auditForm");if(!e)return closeAuditUserModal();var t=e.querySelectorAll(".audit-profile-qty"),n=e.querySelector('input[name="audit_setoran"]'),a=e.querySelector('input[name="audit_setoran_manual"]'),i=0,o={},l={};if(auditUserCache.forEach((function(e){l[String(e.username||"")]=e})),(auditSelectedUsers=Array.from(auditSelectedSet)).forEach((function(e){var t=l[e];if(t){var n=String(t.profile_key||"").toLowerCase();n||(n="other"),o[n]=(o[n]||0)+1,i+=parseInt(t.price||"0",10)||0}})),auditReturTotal>0&&(i+=auditReturTotal),t&&t.length){t.forEach((function(e){var t=String(e.dataset.profileKey||"").toLowerCase();e.value=o[t]||0}));var r=new Event("input",{bubbles:!0});t.forEach((function(e){e.dispatchEvent(r)}))}n&&(n.value=i,n.dataset.manual="0"),a&&(a.value="0"),setAuditQtyLockState(auditSelectedUsers.length>0),updateAuditUserSummary(),closeAuditUserModal()}function softReloadSelling(){var e=document.getElementById("selling-content");if(e&&!window.sellingPauseReload){var t=document.getElementById("hpModal");if(!t||"flex"!==t.style.display){var n=document.getElementById("auditModal");if(!n||"flex"!==n.style.display){var a=new URL(window.location.href),i=new URL("report/aload_selling.php",window.location.origin+window.location.pathname.replace(/\/[^\/]*$/,"/"));a.searchParams.forEach((function(e,t){"ajax"!==t&&i.searchParams.set(t,e)})),fetch(i.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.text()})).then((function(t){e.innerHTML=t})).catch((function(){}))}}}}function formatBytesShortJS(e){var t=parseInt(e||0,10);if(!t||t<=0)return"0 B";for(var n=["B","KB","MB","GB","TB"],a=0,i=t;i>=1024&&a<n.length-1;)i/=1024,a++;var o=a>=2?2:0;return i.toFixed(o)+" "+n[a]}function formatLoginTimeShort(e){if(!e)return"-";var t=String(e);if(-1!==t.indexOf(" ")){var n=t.split(" ");return n[1]||n[0]}return t}function initScrollIndicators(){document.querySelectorAll(".modal-body").forEach((function(e){e.addEventListener("scroll",(function(){var e=this.scrollTop>10;this.classList.toggle("scrolled",e)})),e.scrollTop>10&&e.classList.add("scrolled")}))}function scrollToElementInModal(e,t){var n=document.getElementById(e);if(n){var a=n.querySelector(t);a&&a.scrollIntoView({behavior:"smooth",block:"center"})}}function scrollToAuditField(e){var t=document.querySelector('[name="'+e+'"]');if(t){var n=t.closest(".modal-body");if(n){var a=t.offsetTop-n.offsetTop-20;n.scrollTo({top:a,behavior:"smooth"})}}}function initScrollPadding(){document.querySelectorAll(".modal-body, .audit-user-list").forEach((function(e){e.scrollHeight>e.clientHeight&&(e.style.paddingRight="8px")}))}window.openHpEdit=function(e){var t=document.getElementById("hpForm");if(t&&e){window.hpEditing=!0,t.querySelector('select[name="blok_name"]').value=e.getAttribute("data-blok")||"",t.querySelector('input[name="report_date"]').value=e.getAttribute("data-date")||"",t.querySelector('input[name="rusak_units"]').value=e.getAttribute("data-rusak")||"0",t.querySelector('input[name="spam_units"]').value=e.getAttribute("data-spam")||"0";var n=t.querySelector('input[name="notes"]');n&&(n.value=e.getAttribute("data-notes")||"",updateCharRemainingForInput(n));var a=parseInt(e.getAttribute("data-wartel")||"0",10),i=parseInt(e.getAttribute("data-kamtib")||"0",10),o=t.querySelector('input[name="wartel_units"]'),l=t.querySelector('input[name="kamtib_units"]'),r=t.querySelector('input[name="rusak_units"]'),s=t.querySelector('input[name="spam_units"]');if(o&&(o.value=a),l&&(l.value=i),"function"==typeof window.dispatchEvent){var d=new Event("input",{bubbles:!0});o&&o.dispatchEvent(d),l&&l.dispatchEvent(d),r&&r.dispatchEvent(d),s&&s.dispatchEvent(d)}openHpModal()}},function(){var e=document.getElementById("hpForm");if(e){var t=e.querySelector('select[name="blok_name"]'),n=e.querySelector('input[name="report_date"]');t&&t.addEventListener("change",(function(){applyHpDefaults(!1)})),n&&n.addEventListener("change",(function(){applyHpDefaults(!1)}))}}(),window.openAuditEdit=function(e){var t=document.getElementById("auditForm");if(t&&e){window.auditEditing=!0;var n=e.getAttribute("data-blok")||"",a=e.getAttribute("data-date")||"",i=e.getAttribute("data-user")||"",o=e.getAttribute("data-qty")||"0",l=e.getAttribute("data-setoran")||"0",r=e.getAttribute("data-setoran-manual")||"0",s=e.getAttribute("data-qty10")||"0",d=e.getAttribute("data-qty30")||"0",u=e.getAttribute("data-expense")||"0",c=e.getAttribute("data-expense-desc")||"",m=e.getAttribute("data-profile-qty")||"",p={};if(m)try{p=JSON.parse(m)}catch(e){p={}}var f=t.querySelector('select[name="audit_blok"]');if(f){for(var y=!1,g=0;g<f.options.length;g++)if(f.options[g].value===n){y=!0;break}if(!y&&n){var h=document.createElement("option");h.value=n,h.textContent=n,f.appendChild(h)}f.value=n,f.disabled=!0;var v=t.querySelector('input[name="audit_blok"][data-locked="1"]');v||((v=document.createElement("input")).type="hidden",v.name="audit_blok",v.setAttribute("data-locked","1"),t.appendChild(v)),v.value=n}var w=t.querySelector('input[name="audit_date"]');w&&(w.value=a),"function"==typeof setAuditUserPicker&&setAuditUserPicker(i);var S=t.querySelector('input[name="audit_qty"]');S&&(S.value=o);var E=t.querySelector('input[name="audit_setoran"]'),b=t.querySelector('input[name="audit_setoran_manual"]');E&&(E.value=l,E.dataset.manual="1"===r?"1":"0"),b&&(b.value="1"===r?"1":"0");var I=t.querySelectorAll(".audit-profile-qty");if(I&&I.length){I.forEach((function(e){var t=e.dataset.profileKey||"";t&&p&&Object.prototype.hasOwnProperty.call(p,t)?e.value=p[t]:"audit_qty_10"===e.name?e.value=s:"audit_qty_30"===e.name?e.value=d:e.value=e.value||"0"}));var k=new Event("input",{bubbles:!0});I.forEach((function(e){e.dispatchEvent(k)}))}var U=t.querySelector('input[name="audit_expense_amt"]'),C=t.querySelector('input[name="audit_expense_desc"]');U&&(U.value=u),C&&(C.value=c,updateCharRemainingForInput(C)),openAuditModal()}},function(){var e=document.getElementById("auditForm"),t=document.getElementById("auditSubmitBtn"),n=document.getElementById("auditClientError"),a=e?e.querySelectorAll(".audit-profile-qty"):[],i=e?e.querySelector('input[name="audit_qty"]'):null,o=e?e.querySelector('input[name="audit_setoran"]'):null,l=e?e.querySelector('input[name="audit_setoran_manual"]'):null,r=document.getElementById("audit_setoran_net"),s=e?e.querySelector('input[name="audit_expense_amt"]'):null,d=window.sellingConfig||{},u=parseInt(d.price10||0,10),c=parseInt(d.price30||0,10);function m(){var e=0,t=0;a&&a.length&&a.forEach((function(n){var a=parseInt(n.value||"0",10)||0,i=parseInt(n.dataset.profilePrice||"0",10);i||"audit_qty_10"!==n.name||(i=u),i||"audit_qty_30"!==n.name||(i=c),e+=a,t+=a*i})),i&&(i.value=e),o&&"1"!==o.dataset.manual&&(o.value=t,l&&(l.value="0")),p()}function p(){if(r){var e=(o&&parseInt(o.value||"0",10)||0)-(s&&parseInt(s.value||"0",10)||0);r.value=e>=0?e:0}}a&&a.length&&a.forEach((function(e){e.addEventListener("input",m)})),o&&o.addEventListener("input",(function(){o.dataset.manual="1",l&&(l.value="1"),p()})),s&&s.addEventListener("input",p),m(),e&&e.addEventListener("submit",(function(i){if(i.preventDefault(),!t||!t.disabled){n&&(n.style.display="none");var o=e.querySelector('input[name="audit_qty"]'),l=o?parseInt(o.value||"0",10):0,r=0;a&&a.length&&a.forEach((function(e){var t=parseInt(e.value||"0",10)||0;r+=t}));var s=auditSelectedUsers&&auditSelectedUsers.length>0;if(l<=0)n&&(n.textContent="Qty per profile wajib diisi.",n.style.display="block");else if(!s&&r<=0)n&&(n.textContent="Qty per profile wajib diisi.",n.style.display="block");else if(r>0&&r!==l)n&&(n.textContent="Qty per profile harus sama dengan Qty Manual.",n.style.display="block");else{window.sellingPauseReload=!0;var d=new FormData(e);d.append("ajax","1"),fetch(e.action,{method:"POST",body:d,headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.text()})).then((function(e){var t=null;try{t=JSON.parse(e)}catch(e){}if(t&&t.ok&&t.redirect)window.location.replace(t.redirect);else{var a=t&&t.message?t.message:"Respon tidak valid dari server.";n&&(n.textContent=a,n.style.display="block")}})).catch((function(){n&&(n.textContent="Gagal mengirim data. Coba lagi.",n.style.display="block")}))}}}))}(),window.sellingPauseReload=!1,setInterval(softReloadSelling,3e4),window.openGhostModal=function(e,t,n){var a=window.sellingConfig||{},i=document.getElementById("ghost-modal"),o=document.getElementById("ghost-body"),l=document.getElementById("ghost-status"),r=document.getElementById("ghost-meta");o&&(o.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--txt-muted);padding:20px;">Memuat data...</td></tr>'),l&&(l.textContent="Memindai kandidat anomali..."),r&&(r.textContent="Blok: "+(e||"-")+" | Tanggal: "+(t||"-")+" | Selisih: "+(n||0)+" unit"),i&&(i.style.display="flex"),window.sellingPauseReload=!0;var s=a&&a.ghostUrl?a.ghostUrl:"report/laporan/ghost.php",d=new URL(s,window.location.origin+window.location.pathname.replace(/\/[^\/]*$/,"/"));d.searchParams.set("date",t||""),d.searchParams.set("blok",e||"");var u=document.getElementById("ghost-search");u&&(u.value=""),fetch(d.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.json()})).then((function(e){if(!e||!e.ok)return l&&(l.textContent=e&&e.message?e.message:"Gagal mengambil data anomali."),void(o&&(o.innerHTML='<tr><td colspan="7" style="text-align:center;color:#fca5a5;padding:20px;">Tidak ada data.</td></tr>'));if(l&&(l.textContent="Ditemukan "+e.count+" kandidat."),e.ghosts&&0!==e.ghosts.length){var t=e.ghosts.slice(),n=function(e){var t="";e.forEach((function(e){var n=parseInt(e.confidence||0,10),a=n>=80?"#e74c3c":n>=60?"#f39c12":"#3498db",i=formatLoginTimeShort(e.login_time||"-");t+="<tr><td>"+String(e.username||"-")+'<br><span style="color:#8aa0b4;font-size:11px;">'+String(e.ip||"-")+" | "+String(e.mac||"-")+'</span></td><td class="text-center">'+String(e.profile||"-")+'</td><td class="text-center">'+String(e.status||"-")+'</td><td class="text-center">'+String(e.uptime||"-")+'</td><td class="text-center">'+formatBytesShortJS(e.bytes)+'</td><td class="text-center">'+i+'</td><td class="text-center"><span style="color:'+a+';font-weight:600;">'+n+"%</span></td></tr>"})),o&&(o.innerHTML=t)};u&&(u.oninput=function(){var e=u?String(u.value||"").trim().toLowerCase():"";if(!e)return n(t);var a=t.filter((function(t){return-1!==[t.username,t.ip,t.mac,t.profile,t.status,t.uptime,t.login_time].map((function(e){return String(e||"").toLowerCase()})).join(" | ").indexOf(e)}));n(a)}),n(t)}else o&&(o.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--txt-muted);padding:20px;">Tidak ada kandidat anomali.</td></tr>')})).catch((function(){l&&(l.textContent="Gagal mengambil data ghost."),o&&(o.innerHTML='<tr><td colspan="7" style="text-align:center;color:#fca5a5;padding:20px;">Tidak ada data.</td></tr>')}))},window.closeGhostModal=function(){var e=document.getElementById("ghost-modal");e&&(e.style.display="none"),window.sellingPauseReload=!1},function(){var e=function(){initScrollIndicators(),initScrollPadding(),initCharRemaining()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}();