!function(){const t=(window.usersSession||"").toString(),e=document.getElementById("users-toolbar-form"),n=document.querySelector('input[name="q"]'),a=document.querySelector('select[name="status"]'),s=document.querySelector('select[name="comment"]'),i=document.querySelector('select[name="show"]'),o=document.querySelector('input[name="date"]'),l=document.getElementById("users-table-body"),r=document.getElementById("users-total"),c=document.getElementById("users-active"),d=document.getElementById("users-pagination"),u=document.getElementById("search-loading"),p=document.getElementById("search-clear"),m=document.getElementById("page-dim"),f=document.getElementById("action-banner"),g=document.getElementById("users-overlay"),b=document.getElementById("users-overlay-container"),v=document.getElementById("users-overlay-title"),h=document.getElementById("users-overlay-text"),y=document.getElementById("users-overlay-icon"),k=document.getElementById("users-overlay-actions");let x=null;const w=document.getElementById("relogin-modal"),L=document.getElementById("relogin-body"),_=document.getElementById("relogin-title"),A=document.getElementById("relogin-sub"),E=document.getElementById("relogin-close"),R=document.getElementById("relogin-print"),S=document.getElementById("summary-modal"),B=document.getElementById("summary-open"),T=document.getElementById("summary-close");if(!(n&&l&&r&&d))return;function $(){if(!p)return;const t=""!==n.value.trim();p.classList.toggle("is-visible",t)}B&&S&&B.addEventListener("click",(()=>{S.style.display="flex"})),T&&S&&T.addEventListener("click",(()=>{S.style.display="none"})),S&&S.addEventListener("click",(t=>{t.target===S&&(S.style.display="none")})),function(){const t=window.lowStockInfo||null;if(!t||!t.show)return;if(document.getElementById("low-stock-alert"))return;const e=document.createElement("div");e.id="low-stock-alert",e.className="low-stock-alert";const n=t.label&&"total"!==t.label?" "+t.label:"";e.innerHTML=`\n      <div class="low-stock-text">\n        <i class="fa fa-exclamation-triangle"></i>\n        Stok voucher ready${n} tinggal <strong>${t.total}</strong>. Segera tambah stok.\n      </div>\n      <button type="button" class="low-stock-close" aria-label="Tutup">&times;</button>\n    `,document.body.appendChild(e);const a=e.querySelector(".low-stock-close");a&&a.addEventListener("click",(()=>{e.style.display="none"}))}(),$(),window.addEventListener("focus",$),document.addEventListener("visibilitychange",$);const U="./hotspot/users.php",N=new URLSearchParams(window.location.search);let P=!1,I=0,H=(N.get("q")||"").trim();function C(t){return new Promise((e=>{if(!(g&&b&&v&&h&&y&&k))return void e(null);x&&(clearTimeout(x),x=null);const n=t||{};v.textContent=n.title||"Konfirmasi",h.innerHTML=n.messageHtml||"",b.classList.remove("status-loading","status-success","status-error","status-warning"),"danger"===n.type?(b.classList.add("status-error"),y.className="fa fa-exclamation-triangle",y.style.removeProperty("color")):"warning"===n.type?(b.classList.remove("status-error"),y.className="fa fa-exclamation-circle",y.style.color="#f59e0b"):"info"===n.type?(b.classList.remove("status-error"),y.className="fa fa-info-circle",y.style.color="#3b82f6"):(b.classList.add("status-loading"),y.className="fa fa-question-circle",y.style.removeProperty("color")),"vertical"===n.layout?k.classList.add("layout-vertical"):k.classList.remove("layout-vertical"),k.innerHTML="";const a=Array.isArray(n.buttons)?n.buttons:[],s=t=>{g.classList.remove("show"),x=setTimeout((()=>{g.style.display="none",k.classList.remove("layout-vertical"),x=null}),250),k.innerHTML="",e(t)};a.forEach((t=>{const e=document.createElement("button");e.type="button",e.className="overlay-btn"+(t.className?" "+t.className:""),e.innerHTML=t.label||"OK",t.disabled&&(e.disabled=!0,e.style.opacity="0.6",e.style.cursor="not-allowed"),e.onclick=()=>{t.onClick&&t.onClick(),!1!==t.closeOnClick&&s(t.value??null)},k.appendChild(e)})),g.style.display="flex",g.offsetWidth,g.classList.add("show"),g.onclick=t=>{t.target!==g||n.lockClose||s("cancel")}}))}window.showActionPopup=function(t,e){if(!f)return;f.classList.remove("success","error"),f.classList.add("error"===t?"error":"success"),f.innerHTML=`<i class="fa ${"error"===t?"fa-times-circle":"fa-check-circle"}"></i><span>${e}</span>`,f.style.display="flex";const n=(e||"").length,a=Math.min(8e3,Math.max(4500,55*n));setTimeout((()=>{f.style.display="none"}),a)};function z(e){return new Promise((n=>{if(!g||!h)return void n(!1);const a=e.criteria||{},s=e.values||{},i=e.limits||{},o=e.message||"",l=e.meta||{},r=!!e.ok,c=`\n        <div class="status-banner ${r?"success":"error"}">\n          <i class="fa ${r?"fa-check-circle":"fa-times-circle"}" style="font-size:18px;"></i>\n          <span>${r?"Syarat terpenuhi. User Layak diganti.":"Syarat TIDAK terpenuhi."}</span>\n        </div>`,d=`\n        <div class="checklist-container">\n          <table class="checklist-table">\n            <thead><tr><th>Kriteria</th><th style="text-align:right;">Nilai Aktual</th></tr></thead>\n            <tbody>${[{label:"Offline (Tidak aktif)",ok:!!a.offline,value:"Tidak"===s.online?"Offline":"Online"},{label:`Usage < ${i.bytes||"-"}`,ok:!!a.bytes_ok,value:s.bytes||"-"},{label:"Uptime (Info)",ok:!0,value:s.total_uptime||"-"},{label:"History Login",ok:!!a.first_login_ok,value:"-"!==s.first_login?"Ada":"Kosong"}].map((t=>`\n          <tr>\n            <td><i class="fa ${t.ok?"fa-check":"fa-times"}" style="color:${t.ok?"#4ade80":"#f87171"}; width:16px;"></i> ${t.label}</td>\n            <td style="text-align:right; font-family:monospace;">${t.value}</td>\n          </tr>`)).join("")}</tbody>\n          </table>\n        </div>`,u=l&&l.username?l.username:"Unknown",p=`\n        <div style="text-align:left;">\n          <div style="font-size:14px; color:#cbd5e1; margin-bottom:4px;">Audit User:</div>\n          <div style="font-size:18px; font-weight:bold; color:#fff; margin-bottom:12px;">${u}</div>\n          ${o?`<div style="margin-bottom:8px;color:#f3c969;">${o}</div>`:""}\n          ${c}\n          ${d}\n        </div>`,m=(t||"").toString(),f=u?"./hotspot/print/print.detail.php?session="+encodeURIComponent(m)+"&user="+encodeURIComponent(u):"";C({title:"Verifikasi Kondisi Rusak",messageHtml:p,type:r?"warning":"danger",layout:"vertical",buttons:[{label:'\n              <i class="fa fa-gavel"></i>\n              <div class="btn-rich-text">\n                <span class="btn-rich-title">Tetapkan Status RUSAK</span>\n                <span class="btn-rich-desc">User akan diblokir & laporan disesuaikan.</span>\n              </div>',value:!0,className:"overlay-btn-warning",disabled:!r},{label:'\n              <i class="fa fa-print"></i>\n              <div class="btn-rich-text">\n                <span class="btn-rich-title">Print Rincian</span>\n                <span class="btn-rich-desc">Cetak bukti diagnosa sebelum eksekusi.</span>\n              </div>',className:"overlay-btn-info",closeOnClick:!1,onClick:()=>{if(!f)return;window.open(f,"_blank")||(window.location.href=f)}},{label:'\n              <i class="fa fa-times"></i>\n              <div class="btn-rich-text"><span class="btn-rich-title">Batal</span></div>',value:!1,className:"overlay-btn-muted"}]}).then((t=>n(!0===t)))}))}function D(t){const e=Number(t)||0;if(e<=0)return"0 B";const n=["B","KB","MB","GB","TB"];let a=0,s=e;for(;s>=1024&&a<n.length-1;)s/=1024,a++;const i=a>=2?2:0;return s.toFixed(i).replace(".",",")+" "+n[a]}function M(t){if(!t)return null;const e=Number(t.getAttribute("data-bytes")||0),n=t.getAttribute("data-uptime")||"0s",a=t.getAttribute("data-status")||"",s=t.getAttribute("data-profile")||"",i=t.getAttribute("data-user")||"",o=t.getAttribute("data-blok")||"",l=t.getAttribute("data-first-login")||"",r=t.getAttribute("data-login")||"",c=t.getAttribute("data-logout")||"",d=function(t){const e=(t||"").toLowerCase();return/(\b10\s*(menit|m)\b|10menit)/i.test(e)?{uptime:180,bytes:5242880,uptimeLabel:"3 menit",bytesLabel:"5MB"}:(/(\b30\s*(menit|m)\b|30menit)/i.test(e),{uptime:300,bytes:5242880,uptimeLabel:"5 menit",bytesLabel:"5MB"})}(s),u=(function(t){if(!t)return 0;const e=/(\d+)(w|d|h|m|s)/gi;let n,a=0;for(;null!==(n=e.exec(t));){const t=parseInt(n[1],10)||0,e=n[2].toLowerCase();"w"===e&&(a+=7*t*24*3600),"d"===e&&(a+=24*t*3600),"h"===e&&(a+=3600*t),"m"===e&&(a+=60*t),"s"===e&&(a+=t)}}(n),"ONLINE"!==a),p=r&&"-"!==r?r:c&&"-"!==c?c:"",m=p?j(p):function(){const t=new Date,e=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),a=t.getFullYear();return`${e}-${n}-${a}`}(),f={offline:u,bytes_ok:e<=d.bytes,total_uptime_ok:!0,first_login_ok:!!l},g=f.offline&&f.bytes_ok&&f.first_login_ok;return{ok:g,message:g?"Syarat rusak terpenuhi.":"Syarat rusak belum terpenuhi.",meta:{username:i,blok:Y(o),profile:G(s),date:m,first_login:l||"-",login:r||"-",logout:c||"-"},criteria:f,values:{online:u?"Tidak":"Ya",bytes:D(e),uptime:n,total_uptime:n,first_login:l||"-"},limits:{bytes:d.bytesLabel,uptime:d.uptimeLabel}}}function K(){w&&(w.style.display="none")}window.openDeleteBlockPopup=async function(e){const n=(e||"").toString().trim();if(!n)return;P=!0;const a=!!window.isSuperAdmin,s=`\n      <div style="text-align:left;">\n        <div style="font-weight:600; font-size:15px; margin-bottom:8px; color:#fff;">\n          Target Penghapusan: <span style="color:#f39c12; font-size:16px;">${n}</span>\n        </div>\n        <div style="font-size:13px; color:#b8c7ce; margin-bottom:15px;">\n          Silakan pilih metode penghapusan di bawah ini:\n        </div>\n        ${a?"":'<div class="popup-note"><i class="fa fa-lock"></i> Hapus Total dikunci (Khusus Superadmin).</div>'}\n      </div>`;let i=null;try{i=await C({title:"Hapus Blok Voucher",messageHtml:s,type:"warning",layout:"vertical",buttons:[{label:'\n              <i class="fa fa-server"></i>\n              <div class="btn-rich-text">\n                <span class="btn-rich-title">Hapus Router Saja (Aman)</span>\n                <span class="btn-rich-desc">User offline, Laporan/Uang TETAP ADA.</span>\n              </div>',value:"router",className:"overlay-btn-warning"},{label:'\n              <i class="fa fa-trash"></i>\n              <div class="btn-rich-text">\n                <span class="btn-rich-title">Hapus Total (Router + DB)</span>\n                <span class="btn-rich-desc">Hapus user & HAPUS SEMUA JEJAK UANG.</span>\n              </div>',value:"full",className:"overlay-btn-danger",disabled:!a},{label:'\n              <i class="fa fa-times"></i>\n              <div class="btn-rich-text">\n                <span class="btn-rich-title">Batal</span>\n              </div>',value:"cancel",className:"overlay-btn-muted"}]})}finally{i&&"cancel"!==i||(P=!1)}if(i&&"cancel"!==i)if("router"!==i){if("full"===i){const e=`\n        <div style="text-align:center;">\n          <div style="font-size:18px; color:#ef4444; margin-bottom:10px; font-weight:bold;">PERINGATAN BAHAYA!</div>\n          <div style="color:#e2e8f0; margin-bottom:15px; line-height:1.5;">\n            Anda akan menghapus <strong>${n}</strong> secara PERMANEN.<br><br>\n            <div style="background:rgba(220, 38, 38, 0.2); border:1px solid #dc2626; padding:10px; border-radius:6px; text-align:left; font-size:13px;">\n              <i class="fa fa-exclamation-triangle" style="color:#fca5a5"></i> <strong>Efek Hapus Total:</strong><br>\n              1. User hilang dari Router.<br>\n              2. History Login hilang dari Database.<br>\n              3. <strong>Data Penjualan/Uang HILANG.</strong><br>\n              4. Settlement log ikut dihapus (sesuai tanggal filter jika ada).\n            </div>\n          </div>\n          <div style="font-size:12px; color:#cbd5e1;">Tindakan ini tidak bisa dibatalkan.</div>\n        </div>`;if(!0!==await C({title:"Konfirmasi Hapus Total",messageHtml:e,type:"danger",buttons:[{label:"Batal",value:!1,className:"overlay-btn-muted"},{label:"Ya, HAPUS PERMANEN",value:!0,className:"overlay-btn-danger"}]}))return void(P=!1);const a=(o&&o.value?o.value.trim():"")||(N.get("date")||"").trim();let s="./?hotspot=users&action=delete_block_full&blok="+encodeURIComponent(n)+"&session="+encodeURIComponent(t)+"&delete_settlement=1";a&&(s+="&date="+encodeURIComponent(a)),actionRequest(s,null)}}else{const e=`\n        <div style="text-align:center;">\n          <div style="font-size:16px; margin-bottom:10px;">Konfirmasi Eksekusi</div>\n          <div style="color:#cbd5e1; margin-bottom:15px; font-size:13px;">\n            Anda yakin menghapus user <strong>Router</strong> untuk blok <strong>${n}</strong>?<br>\n            <span style="color:#34d399; font-size:12px;">(Laporan Keuangan Aman)</span>\n          </div>\n        </div>`;if(!0!==await C({title:"Eksekusi Hapus Router",messageHtml:e,type:"warning",buttons:[{label:"Batal",value:!1,className:"overlay-btn-muted"},{label:"Ya, Eksekusi",value:!0,className:"overlay-btn-warning"}]}))return void(P=!1);const a="./?hotspot=users&action=batch_delete&blok="+encodeURIComponent(n)+"&session="+encodeURIComponent(t);actionRequest(a,null)}},window.openUnifiedPrintPopup=async function(t){const e=t&&t.listUrl?t.listUrl:"",n=t&&t.codeUrl?t.codeUrl:"",a=t&&t.blok?t.blok:"-";if(!e&&!n)return;const s=!1!==window.hasUserData,i=`\n      <div style="text-align:left;">\n        <div style="font-weight:600; font-size:15px; margin-bottom:6px; color:#fff;">Pilih Jenis Print</div>\n        <div style="font-size:13px; color:#cbd5e1; margin-bottom:12px;">Pilih salah satu opsi di bawah ini.</div>\n        <div style="background:rgba(59, 130, 246, 0.12); border:1px solid rgba(59, 130, 246, 0.3); padding:10px; border-radius:6px; font-size:12px; color:#e2e8f0;">\n          <strong>Blok:</strong> ${a||"-"}\n        </div>\n      </div>\n    `,o=await C({title:"Print",messageHtml:i,type:"info",layout:"vertical",buttons:[{label:'\n            <i class="fa fa-list"></i>\n            <div class="btn-rich-text">\n              <span class="btn-rich-title">Print List</span>\n              <span class="btn-rich-desc">Cetak daftar sesuai filter saat ini.</span>\n            </div>',value:"list",className:"overlay-btn-info",disabled:!e||!s},{label:'\n            <i class="fa fa-ticket"></i>\n            <div class="btn-rich-text">\n              <span class="btn-rich-title">Print Kode</span>\n              <span class="btn-rich-desc">Cetak voucher sesuai blok terpilih.</span>\n            </div>',value:"code",className:"overlay-btn-info",disabled:!n},{label:'\n            <i class="fa fa-times"></i>\n            <div class="btn-rich-text"><span class="btn-rich-title">Batal</span></div>',value:"cancel",className:"overlay-btn-muted"}]});if("list"===o){window.open(e,"_blank")||(window.location.href=e)}else if("code"===o){const t=window.open(n,"_blank");if(t)try{t.onload=function(){setTimeout((()=>{try{t.print()}catch(t){}}),400)}}catch(t){}else window.location.href=n}},window.actionRequest=async function(e,n){if(P=!0,n){const t=n.toLowerCase();if(t.includes("hapus total user")){const t=n.match(/user\s+([^\s]+)/i),e=`\n          <div style="text-align:left;">\n             <div style="margin-bottom:10px; color:#cbd5e1;">Anda akan menghapus user:</div>\n             <div style="font-size:20px; font-weight:bold; color:#fff; margin-bottom:15px; border-left:4px solid #ef4444; padding-left:12px;">\n               ${t?t[1]:"Target"}\n             </div>\n             <div style="background:rgba(239, 68, 68, 0.1); border:1px solid rgba(239, 68, 68, 0.3); padding:10px; border-radius:6px; font-size:13px; color:#fca5a5;">\n               <i class="fa fa-exclamation-triangle"></i> <strong>Peringatan:</strong><br>\n               Tindakan ini akan menghapus user dari MikroTik DAN menghapus seluruh riwayat keuangan/login di database. Data tidak bisa dikembalikan.\n             </div>\n             ${n.includes("[RETUR_PAIR]")?'\n             <div class="popup-info-box purple" style="margin-top:12px;">\n               <i class="fa fa-exchange" style="font-size:18px; color:#a569bd; margin-top:2px;"></i>\n               <div>\n                 <strong>Terindikasi Retur:</strong><br>\n                 Sistem akan menghapus <strong>user lama</strong> dan <strong>user hasil retur</strong> sekaligus.\n               </div>\n             </div>\n        ':""}\n          </div>\n        `;if(!await C({title:"Hapus User Permanen",messageHtml:e,type:"danger",layout:"vertical",buttons:[{label:'\n                <i class="fa fa-trash"></i>\n                <div class="btn-rich-text">\n                  <span class="btn-rich-title">Ya, Hapus Total</span>\n                  <span class="btn-rich-desc">Hapus Router + Database Permanen.</span>\n                </div>',value:!0,className:"overlay-btn-danger"},{label:"Batal",value:!1,className:"overlay-btn-muted"}]}))return void(P=!1);n=null}else if(t.includes("disable voucher")){const t=n.match(/Voucher\s+([^\?]+)/i),e=`\n          <div style="text-align:left;">\n             <div style="margin-bottom:8px; color:#cbd5e1; font-size:13px;">Target Nonaktif:</div>\n             <div style="font-size:20px; font-weight:bold; color:#fff; margin-bottom:15px; border-left:4px solid #f59e0b; padding-left:12px;">\n               ${t?t[1].trim():"Target"}\n             </div>\n             <div style="background:rgba(245, 158, 11, 0.1); border:1px solid rgba(245, 158, 11, 0.3); padding:12px; border-radius:6px; font-size:13px; color:#e2e8f0; line-height:1.5;">\n               <div style="display:flex; gap:10px;">\n                 <i class="fa fa-lock" style="font-size:16px; color:#fca5a5; margin-top:2px;"></i>\n                 <div>\n                   <strong>Efek Disable:</strong><br>\n                   <span style="color:#cbd5e1;">User tidak akan bisa login hotspot.</span><br>\n                   <span style="color:#34d399; font-weight:600;"><i class="fa fa-check"></i> Data & Uang TETAP AMAN.</span>\n                 </div>\n               </div>\n             </div>\n          </div>\n        `;if(!await C({title:"Konfirmasi Disable",messageHtml:e,type:"warning",layout:"vertical",buttons:[{label:'\n                <i class="fa fa-ban"></i>\n                <div class="btn-rich-text">\n                  <span class="btn-rich-title">Ya, Disable Voucher</span>\n                  <span class="btn-rich-desc">Matikan akses login user ini sekarang.</span>\n                </div>',value:!0,className:"overlay-btn-danger"},{label:'\n                <i class="fa fa-times"></i>\n                <div class="btn-rich-text"><span class="btn-rich-title">Batal</span></div>',value:!1,className:"overlay-btn-muted"}]}))return void(P=!1);n=null}else if(t.includes("retur voucher")){const t=n.match(/RETUR Voucher\s+([^\?]+)/i),e=t?t[1].trim():"Target",a=`\n          <div style="text-align:left;">\n             <div style="margin-bottom:8px; color:#cbd5e1; font-size:13px;">Target Retur:</div>\n             <div style="font-size:20px; font-weight:bold; color:#fff; margin-bottom:15px; border-left:4px solid #8e44ad; padding-left:12px;">\n               ${e}\n             </div>\n             \n             <div class="popup-info-box purple">\n               <i class="fa fa-exchange" style="font-size:18px; color:#a569bd; margin-top:2px;"></i>\n               <div>\n                 <strong>Mekanisme Retur:</strong><br>\n                 1. Voucher lama (${e}) akan dihapus/diarsipkan.<br>\n                 2. <strong>Voucher BARU</strong> akan otomatis dibuat sebagai pengganti.<br>\n                 <span style="color:#d2b4de; font-size:12px;">(Saldo/Laporan tidak berubah, hanya tukar voucher).</span>\n               </div>\n             </div>\n          </div>\n        `;if(!await C({title:"Konfirmasi Retur",messageHtml:a,type:"warning",layout:"vertical",buttons:[{label:'\n                <i class="fa fa-random"></i>\n                <div class="btn-rich-text">\n                  <span class="btn-rich-title">Ya, Proses Retur</span>\n                  <span class="btn-rich-desc">Generate voucher pengganti sekarang.</span>\n                </div>',value:!0,className:"overlay-btn-purple"},{label:'\n                <i class="fa fa-times"></i>\n                <div class="btn-rich-text"><span class="btn-rich-title">Batal</span></div>',value:!1,className:"overlay-btn-muted"}]}))return void(P=!1);n=null}else if(t.includes("rollback rusak")){const t=n.match(/Rollback RUSAK\s+([^\?]+)/i),e=`\n          <div style="text-align:left;">\n             <div style="margin-bottom:8px; color:#cbd5e1; font-size:13px;">Target Pemulihan:</div>\n             <div style="font-size:20px; font-weight:bold; color:#fff; margin-bottom:15px; border-left:4px solid #2ecc71; padding-left:12px;">\n               ${t?t[1].trim():"Target"}\n             </div>\n             \n             <div class="popup-info-box green">\n               <i class="fa fa-undo" style="font-size:18px; color:#4ade80; margin-top:2px;"></i>\n               <div>\n                 <strong>Efek Rollback:</strong><br>\n                 Status voucher akan dikembalikan dari <strong>RUSAK</strong> menjadi <strong>READY/AKTIF</strong>.<br>\n                 <span style="color:#86efac; font-weight:600;"><i class="fa fa-check"></i> User bisa login kembali.</span>\n               </div>\n             </div>\n          </div>\n        `;if(!await C({title:"Batalkan Status Rusak",messageHtml:e,type:"info",layout:"vertical",buttons:[{label:'\n                <i class="fa fa-history"></i>\n                <div class="btn-rich-text">\n                  <span class="btn-rich-title">Ya, Pulihkan Voucher</span>\n                  <span class="btn-rich-desc">Kembalikan akses user ini.</span>\n                </div>',value:!0,className:"overlay-btn-success"},{label:'\n                <i class="fa fa-times"></i>\n                <div class="btn-rich-text"><span class="btn-rich-title">Batal</span></div>',value:!1,className:"overlay-btn-muted"}]}))return void(P=!1);n=null}else{if(!await C({title:"Konfirmasi",messageHtml:`<div style="text-align:left;font-size:14px;">${n}</div>`,type:"info",buttons:[{label:"Batal",value:!1,className:"overlay-btn-muted"},{label:"Ya, Lanjutkan",value:!0,className:"overlay-btn-secondary"}]}))return void(P=!1);n=null}}try{m&&(m.style.display="flex");const n=e+(e.includes("?")?"&":"?")+"ajax=1&action_ajax=1&_="+Date.now(),a=await fetch(n,{cache:"no-store"}),i=await a.text();let o=null;try{o=JSON.parse(i)}catch(t){o=null}if(o&&o.ok){if(e.includes("action=batch_delete")||e.includes("action=delete_block_full")){await new Promise((t=>setTimeout(t,300)));const e=o.message||"Blok berhasil dihapus.";return void await C({title:"Sukses Hapus Blok",messageHtml:`\n              <div style="text-align:center;">\n                <div style="font-size:50px; color:#10b981; margin-bottom:15px;"><i class="fa fa-check-circle"></i></div>\n                <div style="font-size:18px; font-weight:bold; color:#fff; margin-bottom:10px;">Penghapusan Selesai!</div>\n                <div style="color:#e2e8f0; margin-bottom:20px; font-size:14px; line-height:1.5;">${e}</div>\n                <div style="background:rgba(16, 185, 129, 0.1); border:1px solid rgba(16, 185, 129, 0.3); padding:10px; border-radius:6px; font-size:12px; color:#a7f3d0;">\n                    Database dan Router telah disinkronisasi.\n                </div>\n              </div>`,type:"info",buttons:[{label:"Tutup & Reload",value:!0,className:"overlay-btn-success",onClick:()=>{window.location.href="./?hotspot=users&session="+encodeURIComponent(t)}}],lockClose:!0})}if(window.showActionPopup("success",o.message||"Berhasil diproses."),P=!1,o.new_user){const e="./voucher/print.php?user=vc-"+encodeURIComponent(o.new_user)+"&small=yes&session="+encodeURIComponent(t);setTimeout((()=>{const t=window.open(e,"_blank");if(t)try{t.onload=function(){setTimeout((()=>{try{t.print()}catch(t){}}),400)}}catch(t){}}),500)}if(e.includes("action=delete_status")){const e=new URLSearchParams(window.location.search);return e.set("hotspot","users"),e.set("session",t),e.set("status","all"),s&&e.set("comment",s.value),e.delete("page"),void(window.location.href="./?"+e.toString())}if(o.redirect)try{history.replaceState(null,"",o.redirect)}catch(t){}W(!0,!1)}else if(o)window.showActionPopup("error",o&&o.message?o.message:"Gagal memproses."),P=!1;else{if(e.includes("action=batch_delete")||e.includes("action=delete_block_full")){const e="Blok berhasil dihapus.";return void await C({title:"Sukses Hapus Blok",messageHtml:`\n              <div style="text-align:center;">\n                <div style="font-size:50px; color:#10b981; margin-bottom:15px;"><i class="fa fa-check-circle"></i></div>\n                <div style="font-size:18px; font-weight:bold; color:#fff; margin-bottom:10px;">Penghapusan Selesai!</div>\n                <div style="color:#e2e8f0; margin-bottom:20px; font-size:14px; line-height:1.5;">${e}</div>\n              </div>`,type:"info",buttons:[{label:"Tutup & Reload",value:!0,className:"overlay-btn-success",onClick:()=>{window.location.href="./?hotspot=users&session="+encodeURIComponent(t)}}],lockClose:!0})}if(window.showActionPopup("success","Berhasil diproses."),P=!1,e.includes("action=delete_status")){const e=new URLSearchParams(window.location.search);return e.set("hotspot","users"),e.set("session",t),e.set("status","all"),s&&e.set("comment",s.value),e.delete("page"),void(window.location.href="./?"+e.toString())}W(!0,!1)}}catch(t){window.showActionPopup("error","Gagal memproses."),P=!1}finally{m&&(m.style.display="none")}},window.actionRequestRusak=async function(e,n,a){let s=null,i="",o=[];"string"==typeof e?i=e:(s=e,i=n);try{if(s){const e=s.getAttribute("data-user")||"";if(e)try{const n=new URLSearchParams;n.set("action","login_events"),n.set("name",e),n.set("session",t);const a=O(s.getAttribute("data-first-login")||"");a&&(n.set("show","harian"),n.set("date",a)),n.set("ajax","1"),n.set("_",Date.now().toString());const i=await fetch(U+"?"+n.toString(),{cache:"no-store"}),l=await i.json();l&&Array.isArray(l.events)&&(o=l.events)}catch(t){}}const e=i.replace("action=invalid","action=check_rusak"),n=e+(e.includes("?")?"&":"?")+"ajax=1&action_ajax=1&_="+Date.now(),a=await fetch(n,{cache:"no-store"}),l=await a.text();let r=null;try{r=JSON.parse(l)}catch(t){r=null}if(r||(r=M(s)||{ok:!1,message:"Gagal memproses. Data validasi tidak terbaca.",criteria:{},values:{},limits:{},meta:{}}),r&&!r.meta&&(r.meta={}),r&&r.meta){o.length>0&&(r.meta.relogin_events=o),o.length>0&&(r.meta.relogin_count=o.length);const t=O(s&&s.getAttribute("data-first-login")||"");if(t&&(r.meta.relogin_date=t),!r.meta.username){const t=s&&s.getAttribute("data-user")||"",e=i.match(/name=([^&]+)/i),n=e?decodeURIComponent(e[1]):"";r.meta.username=t||n||""}}if(!await z(r))return;window.actionRequest(i,null)}catch(t){const e=M(s)||{ok:!1,message:"Gagal memproses. Tidak bisa mengambil data validasi.",criteria:{},values:{},limits:{}};await z(e)}};let q=null;function j(t){if(!t)return"";const e=t.split(" ");if(!e[0])return"";const n=e[0].split("-");return 3!==n.length?"":`${n[2]}-${n[1]}-${n[0]}`}function O(t){if(!t)return"";const e=t.split(" ")[0]||"";return/^\d{4}-\d{2}-\d{2}$/.test(e)?e:""}function Y(t){if(!t)return"";const e=t.replace(/^BLOK-?/i,"").trim(),n=e.match(/^([A-Z]+)/i);return n?n[1].toUpperCase():e.toUpperCase()}function G(t){return t?t.replace(/(\d+)\s*(menit)/i,"$1 Menit"):""}function V(t){if(!t)return"-";return t.split(" ")[1]||"-"}function J(t){const e=new URL(window.location.href);t?(e.searchParams.set("q",t),e.searchParams.set("page","1")):(e.searchParams.delete("q"),e.searchParams.delete("page"));try{history.replaceState(null,"",e.toString())}catch(t){}}async function F(){if(c)try{const e="./hotspot/user/aload_users.php?session="+encodeURIComponent(t)+"&load=users_status&_="+Date.now(),n=await fetch(e,{cache:"no-store"});if(!n.ok)return;const a=await n.json();a&&Array.isArray(a.active)&&(c.textContent=`Online: ${a.active.length} User`)}catch(t){}}async function W(e,c){const p=++I;try{e&&(H=n.value.trim()),c&&u&&(u.style.display="inline-block"),c&&m&&(m.style.display="flex");const f=await fetch(function(e){const l=new URLSearchParams;l.set("session",t),l.set("ajax","1");const r=e?n.value.trim():H;l.set("q",r),a&&l.set("status",a.value),s&&l.set("comment",s.value),i&&l.set("show",i.value),o&&l.set("date",o.value);const c=N.get("profile");c&&l.set("profile",c);const d=N.get("per_page");d&&l.set("per_page",d);const u=N.get("debug");u&&l.set("debug",u);const p=N.get("readonly");return p&&l.set("readonly",p),e&&l.set("page","1"),l.set("_",Date.now().toString()),U+"?"+l.toString()}(e),{headers:{"X-Requested-With":"XMLHttpRequest"},cache:"no-store"});if(!f.ok)return;const g=await f.json();if(p!==I)return;"string"==typeof g.rows_html&&(l.innerHTML=g.rows_html),"string"==typeof g.pagination_html&&(d.innerHTML=g.pagination_html),"string"==typeof g.total_label&&(r.textContent=g.total_label)}catch(t){}finally{c&&u&&(u.style.display="none"),c&&m&&(m.style.display="none")}}function X(){if(P)return!1;if(g&&g.classList.contains("show"))return!1;const t=!a||"all"===a.value,e=!s||""===s.value;return t&&e}n.addEventListener("keydown",(t=>{if("Enter"===t.key){t.preventDefault();const e=""!==n.value.trim();J(n.value.trim()),W(!0,e)}})),n.addEventListener("input",(()=>{$()})),n.addEventListener("blur",(()=>{$()})),p&&p.addEventListener("click",(()=>{""!==n.value&&(n.value="",$(),J(""),W(!0,!0),n.focus())})),e&&e.addEventListener("submit",(t=>{if(document.activeElement===n){t.preventDefault();W(!0,""!==n.value.trim())}})),l&&l.addEventListener("click",(e=>{const n=e.target.closest(".st-relogin");if(!n)return;const a=n.getAttribute("data-user")||"",s=n.getAttribute("data-blok")||"",l=n.getAttribute("data-profile")||"";a&&async function(e,n,a){if(w&&L){_&&(_.textContent=`Detail Relogin - ${e}`),A&&(A.textContent=""),L.innerHTML='<div style="text-align:center;color:#9aa0a6;">Memuat...</div>',w.style.display="flex",q=null;try{const s=new URLSearchParams;s.set("action","login_events"),s.set("name",e),s.set("session",t),i&&s.set("show",i.value),o&&s.set("date",o.value),s.set("ajax","1"),s.set("_",Date.now().toString());const l=await fetch(U+"?"+s.toString(),{cache:"no-store"}),r=await l.json();if(!r||!r.ok)return void(L.innerHTML='<div style="text-align:center;color:#ff6b6b;">Gagal memuat data.</div>');const c=Array.isArray(r.events)?r.events:[];if(0===c.length)return void(L.innerHTML='<div style="text-align:center;color:#9aa0a6;">Tidak ada data relogin.</div>');const d=c.find((t=>t.login_time||t.logout_time)),u=d?j(d.login_time||d.logout_time):"";if(A){const t=[];u&&t.push(u),n&&t.push(`Blok ${Y(n)}`),a&&t.push(G(a)),A.textContent=t.join(" · ")}let p='<table class="relogin-table"><thead><tr><th>#</th><th>Login</th><th>Logout</th></tr></thead><tbody>';c.forEach(((t,e)=>{const n=t.seq||e+1,a=V(t.login_time),s=V(t.logout_time),i=!t.login_time&&t.logout_time?'<span class="relogin-note">logout tanpa login</span>':"";p+=`<tr><td>#${n}</td><td>${a}${i}</td><td>${s}</td></tr>`})),p+="</tbody></table>",(r.total||0)>c.length&&(p+='<div class="relogin-more">lebih...</div>'),L.innerHTML=p,q={username:e,events:c,headerDate:u,blok:n,profile:a}}catch(t){L.innerHTML='<div style="text-align:center;color:#ff6b6b;">Gagal memuat data.</div>'}}}(a,s,l)})),E&&E.addEventListener("click",K),R&&R.addEventListener("click",(()=>{if(!q||!q.events)return;const{username:t,events:e,headerDate:n,blok:a,profile:s}=q,i=e.map(((t,e)=>{const n=t.seq||e+1,a=V(t.login_time),s=V(t.logout_time);return`<tr><td>#${n}</td><td>${a}${!t.login_time&&t.logout_time?" (logout tanpa login)":""}</td><td>${s}</td></tr>`})).join(""),o=[];n&&o.push(n),a&&o.push(`Blok ${Y(a)}`),s&&o.push(G(s));const l=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Detail Relogin</title>\n        <style>\n          body{font-family:Arial,sans-serif;color:#111;margin:20px;}\n          h3{margin:0 0 10px 0;}\n          table{width:100%;border-collapse:collapse;font-size:12px;}\n          th,td{border:1px solid #444;padding:6px 8px;}\n          th{background:#f0f0f0;text-align:left;}\n        </style>\n      </head><body>\n        <h3>Detail Relogin - ${t}</h3>\n        ${o.length?`<div style="margin:6px 0 10px 0;font-size:12px;color:#444;">${o.join(" · ")}</div>`:""}\n        <table><thead><tr><th>#</th><th>Login</th><th>Logout</th></tr></thead><tbody>${i}</tbody></table>\n      </body></html>`,r=window.open("","_blank");r&&(r.document.open(),r.document.write(l),r.document.close(),r.focus(),r.print())})),w&&w.addEventListener("click",(t=>{t.target===w&&K()})),setInterval((()=>{if(document.hidden)return;if(!X())return;n.value.trim()===H&&(W(!1,!1),F())}),15e3),X()&&F()}();