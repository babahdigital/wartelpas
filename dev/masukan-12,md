Berikut adalah **Analisa Holistik dan Masukan Strategis** mengenai penggunaan tools administrasi (`audit_sales.php`, `check_block.php`, `check_duplicate_sales.php`, `cleanup_sales_today.php`, `cleanup_users_today.php`, `clear_all.php`, `clear_block.php`, `clear_block_sales_today.php`, `clear_block_users.php`, `delete_user.php`) dalam ekosistem WartelPas Anda.

Tools ini sangat powerful namun berbahaya jika salah digunakan. Saya akan mengelompokkannya berdasarkan **Role (Superadmin vs Operator)** dan memberikan **SOP (Standard Operating Procedure)** penggunaannya agar sistem Anda sempurna dan aman.

---

### 1. Klasifikasi & Akses Kontrol (Security Matrix)

Saat ini, hampir semua tools memiliki `requireSuperAdmin` atau validasi token. Ini sudah sangat bagus. Namun, untuk operasional harian, kita perlu membedakan mana yang boleh diakses Operator (via UI Report) dan mana yang eksklusif Superadmin (Maintenance).

| Kategori | Nama File | Target User | Fungsi Utama | Risiko |
| --- | --- | --- | --- | --- |
| **Audit** | `audit_sales.php` | Superadmin | Cek duplikasi & anomali data (read-only). | Rendah |
| **Audit** | `check_block.php` | Operator/Admin | Cek jumlah data per blok (validasi sebelum hapus). | Rendah |
| **Audit** | `check_duplicate_sales.php` | Superadmin | Cek duplikasi detail (read-only). | Rendah |
| **Cleanup** | `cleanup_sales_today.php` | System (Cron) / Admin | Hapus duplikasi penjualan hari ini (auto-dedup). | Sedang |
| **Cleanup** | `cleanup_users_today.php` | System (Cron) / Admin | Hapus duplikasi login history hari ini. | Sedang |
| **Destruktif** | `clear_all.php` | **SUPERADMIN ONLY** | Reset total database (awal tahun/install baru). | **KRITIS** |
| **Destruktif** | `clear_block.php` | Superadmin | Hapus data blok spesifik (salah input massal). | Tinggi |
| **Destruktif** | `clear_block_sales_today.php` | Superadmin | Hapus penjualan blok tertentu hari ini (koreksi). | Tinggi |
| **Destruktif** | `clear_block_users.php` | Superadmin | Hapus user blok tertentu (database + mikrotik). | Tinggi |
| **Koreksi** | `delete_user.php` | Admin | Hapus 1 user spesifik (anomali/error). | Sedang |

---

### 2. Strategi Integrasi & SOP Penggunaan

Agar tools ini tidak hanya menjadi script tersembunyi, berikut cara memanfaatkannya dalam alur kerja (workflow) WartelPas:

#### A. Skenario: Operator Melapor "Laporan Double" atau "Data Aneh"

**Tools:** `audit_sales.php` & `check_duplicate_sales.php`

1. **Langkah Superadmin:** Buka `audit_sales.php` (via URL browser).
2. **Analisa:** Lihat bagian "Duplicate full_raw_data". Jika ada > 0, berarti script Mikrotik mengirim data ganda (koneksi tidak stabil).
3. **Tindakan:** Jalankan `cleanup_sales_today.php?date=YYYY-MM-DD` untuk membersihkan duplikasi secara otomatis tanpa menghapus data asli.

#### B. Skenario: Pergantian Shift / Salah Input Blok Massal

**Tools:** `clear_block_users.php` & `clear_block_sales_today.php`

* **Kasus:** Operator salah generate "BLOK-A" padahal harusnya "BLOK-B". User belum dipakai login.
* **Tindakan:**
1. Gunakan `check_block.php?blok=BLOK-A` untuk melihat berapa user yang terdampak.
2. Jika yakin, jalankan `clear_block_users.php?blok=BLOK-A&confirm=YES&mikrotik=1`. Ini akan menghapus user dari DB dan Mikrotik sekaligus.



#### C. Skenario: Maintenance Harian Otomatis (Cron Job)

**Tools:** `cleanup_sales_today.php` & `cleanup_users_today.php`

* **Masukan Holistik:** Jangan biarkan tools ini menganggur. Pasang di **Scheduler Mikrotik** atau **Cron Server** (jika ada).
* **Setting:** Jalankan setiap jam 23:55.
* **Tujuannya:** Memastikan laporan harian bersih dari duplikasi sebelum hari berganti, sehingga Laporan Bulanan (yang merekap harian) selalu akurat.

#### D. Skenario: Awal Tahun Baru / Reset Sistem

**Tools:** `clear_all.php`

* **SOP:**
1. **BACKUP DULU!** Download `mikhmon_stats.db`.
2. Jalankan `clear_all.php?confirm=YES`.
3. Sistem kembali ke nol (kosong) siap untuk tahun buku baru.



---

### 3. Masukan Penyempurnaan Code (Technical Review)

Saya melihat kode tools ini sudah cukup aman, namun ada beberapa *hardening* yang bisa ditambahkan agar "Sempurna":

1. **Validasi Tanggal (`delete_user.php` dll):**
Saat ini validasi tanggal di beberapa file hanya `trim`. Sebaiknya gunakan regex `preg_match('/^\d{4}-\d{2}-\d{2}$/', $date)` agar tidak ada yang iseng inject query SQL via parameter tanggal (meski PDO sudah aman, validasi input tetap *best practice*).
2. **Log Aktivitas Admin:**
Saat ini tools destruktif (`clear_*.php`) langsung eksekusi dan echo "OK".
**Saran:** Tambahkan pencatatan ke file log (misal `logs/admin_actions.log`).
* *Contoh:* `[2026-01-27 12:00] Superadmin deleted BLOK-A sales via clear_block.php`.
* Ini penting untuk audit jejak jika suatu hari data hilang misterius.


3. **Unifikasi Token:**
Anda menggunakan logika:
```php
$secret_token = $env['security']['tools']['token'] ?? ...

```


Ini sudah bagus. Pastikan file `env.php` Anda memiliki entri khusus untuk `['security']['tools']['token']` yang berbeda dengan token sinkronisasi Mikrotik, agar jika token Mikrotik bocor, attacker tidak bisa mereset database via tools ini.

### 4. Kesimpulan Holistik

Kumpulan tools ini adalah **"Kotak P3K & Bengkel"** bagi sistem WartelPas Anda.

* **Operator** tidak perlu akses ke sini (kecuali mungkin fitur view `check_block` jika diintegrasikan ke dashboard).
* **Superadmin** wajib bookmark URL tools ini.

**Rekomendasi Final:**
Buat satu halaman sederhana (misal `tools/index.php` atau menu di Admin Panel) yang hanya bisa diakses Superadmin. Halaman itu berisi link/tombol ke script-script ini dengan UI yang ramah (form input tanggal/blok), sehingga Anda tidak perlu mengetik URL parameter manual di browser saat keadaan darurat.

Dengan toolset ini, sistem Anda tidak hanya bisa mencatat transaksi, tapi juga memiliki **kemampuan pemulihan diri (self-healing)** dan **koreksi manual** yang lengkap.